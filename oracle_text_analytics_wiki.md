# 🧠 Survey Comment Text Analytics Using Oracle

This guide outlines how we process and analyze unstructured survey comments using **Oracle Text**, with support for keyword groups, rule matching, macro expansion, proximity search, and analytics summarization.

---

## 📦 Database Structure

### **1. survey_comments**
Stores individual survey responses.

```sql
CREATE TABLE survey_comments (
  id NUMBER GENERATED BY DEFAULT AS IDENTITY,
  respondent_id NUMBER,
  comment_text CLOB,
  created_at DATE DEFAULT SYSDATE
);
```

### **2. word_groups**
Defines reusable keyword macros (e.g., `#client_group`).

```sql
CREATE TABLE word_groups (
  group_name VARCHAR2(100) PRIMARY KEY,  -- e.g. '#client_group'
  words      CLOB                        -- e.g. 'client OR customer OR user'
);
```

### **3. comment_rules**
Contains rules to match survey comments (includes topic, expression, and exclusion).

```sql
CREATE TABLE comment_rules (
  id NUMBER GENERATED BY DEFAULT AS IDENTITY,
  topic VARCHAR2(255),
  rule_expr_raw CLOB,      -- e.g. '#client_group NEAR onboarding'
  exclude_expr_raw CLOB    -- e.g. 'attorney OR legal'
);
```

---

## 🔍 Oracle Text Indexing

Create a `CONTEXT` index on the `comment_text` column:

```sql
CREATE INDEX comment_text_idx 
ON survey_comments(comment_text) 
INDEXTYPE IS CTXSYS.CONTEXT;
```

---

## 🔁 Macro Expansion Function

Used to replace tokens like `#group` with their expanded terms.

```sql
CREATE OR REPLACE FUNCTION expand_macros(expr IN CLOB) RETURN CLOB IS
  expanded_expr CLOB := expr;
BEGIN
  FOR macro IN (SELECT group_name, words FROM word_groups) LOOP
    expanded_expr := REPLACE(expanded_expr, macro.group_name, '(' || macro.words || ')');
  END LOOP;
  RETURN expanded_expr;
END;
```

---

## 🔍 Search & Highlight

### **Find Comments Matching Rules**
```sql
SELECT c.id, c.comment_text
FROM survey_comments c
JOIN comment_rules r
  ON CONTAINS(c.comment_text, expand_macros(r.rule_expr_raw), 1) > 0
WHERE r.exclude_expr_raw IS NULL 
   OR CONTAINS(c.comment_text, expand_macros(r.exclude_expr_raw), 2) = 0;
```

### **Get Highlighted Snippet**
```sql
SELECT CTX_DOC.SNIPPET('comment_text_idx', c.id, expand_macros(r.rule_expr_raw)) AS snippet
FROM survey_comments c
JOIN comment_rules r
  ON CONTAINS(c.comment_text, expand_macros(r.rule_expr_raw), 1) > 0;
```

---

## 📊 Summary Reporting

### **Option 1: Materialized View**
```sql
CREATE MATERIALIZED VIEW comment_rule_summary_mv
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS
SELECT r.id AS rule_id, r.topic, COUNT(*) AS match_count
FROM survey_comments c
JOIN comment_rules r
  ON CONTAINS(c.comment_text, expand_macros(r.rule_expr_raw), 1) > 0
WHERE r.exclude_expr_raw IS NULL
   OR CONTAINS(c.comment_text, expand_macros(r.exclude_expr_raw), 2) = 0
GROUP BY r.id, r.topic;
```

Refresh manually:
```sql
EXEC DBMS_MVIEW.REFRESH('comment_rule_summary_mv');
```

---

### **Option 2: Analytics Summary Table**

```sql
CREATE TABLE comment_rule_summary (
  rule_id NUMBER,
  rule_label VARCHAR2(255),
  topic VARCHAR2(255),
  match_count NUMBER,
  last_updated DATE DEFAULT SYSDATE
);
```

#### **Refresh Procedure**
```sql
CREATE OR REPLACE PROCEDURE refresh_comment_rule_summary IS
BEGIN
  DELETE FROM comment_rule_summary;

  INSERT INTO comment_rule_summary (rule_id, rule_label, topic, match_count)
  SELECT r.id, r.rule_expr_raw, r.topic, COUNT(*)
  FROM survey_comments c
  JOIN comment_rules r
    ON CONTAINS(c.comment_text, expand_macros(r.rule_expr_raw), 1) > 0
  WHERE r.exclude_expr_raw IS NULL
     OR CONTAINS(c.comment_text, expand_macros(r.exclude_expr_raw), 2) = 0
  GROUP BY r.id, r.rule_expr_raw, r.topic;

  COMMIT;
END;
```

#### **Scheduled Refresh**
```sql
BEGIN
  DBMS_SCHEDULER.CREATE_JOB (
    job_name        => 'refresh_rule_summary',
    job_type        => 'STORED_PROCEDURE',
    job_action      => 'refresh_comment_rule_summary',
    repeat_interval => 'FREQ=HOURLY;',
    enabled         => TRUE
  );
END;
```

---

## ⏱ Index Maintenance

Sync the Oracle Text index periodically:

```sql
BEGIN
  DBMS_SCHEDULER.CREATE_JOB (
    job_name        => 'sync_comment_text_index_hourly',
    job_type        => 'PLSQL_BLOCK',
    job_action      => 'BEGIN CTX_DDL.SYNC_INDEX(''comment_text_idx''); END;',
    repeat_interval => 'FREQ=HOURLY;BYMINUTE=0',
    enabled         => TRUE
  );
END;
```