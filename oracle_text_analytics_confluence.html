<h1>üß† Survey Comment Text Analytics Using Oracle<br><br>This guide outlines how we process and analyze unstructured survey comments using **Oracle Text**, with support for keyword groups, rule matching, macro expansion, proximity search, and analytics summarization.<br><br>---<br><br>#<h1>üì¶ Database Structure<br><br>##<h1>**1. survey_comments**<br>Stores individual survey responses.<br><br><pre><code class='sql'><br>CREATE TABLE survey_comments (<br>  id NUMBER GENERATED BY DEFAULT AS IDENTITY,<br>  respondent_id NUMBER,<br>  comment_text CLOB,<br>  created_at DATE DEFAULT SYSDATE<br>);<br></code></pre><br><br>##<h1>**2. word_groups**<br>Defines reusable keyword macros (e.g., `#client_group`).<br><br><pre><code class='sql'><br>CREATE TABLE word_groups (<br>  group_name VARCHAR2(100) PRIMARY KEY,  -- e.g. '#client_group'<br>  words      CLOB                        -- e.g. 'client OR customer OR user'<br>);<br></code></pre><br><br>##<h1>**3. comment_rules**<br>Contains rules to match survey comments (includes topic, expression, and exclusion).<br><br><pre><code class='sql'><br>CREATE TABLE comment_rules (<br>  id NUMBER GENERATED BY DEFAULT AS IDENTITY,<br>  topic VARCHAR2(255),<br>  rule_expr_raw CLOB,      -- e.g. '#client_group NEAR onboarding'<br>  exclude_expr_raw CLOB    -- e.g. 'attorney OR legal'<br>);<br></code></pre><br><br>---<br><br>#<h1>üîç Oracle Text Indexing<br><br>Create a `CONTEXT` index on the `comment_text` column:<br><br><pre><code class='sql'><br>CREATE INDEX comment_text_idx <br>ON survey_comments(comment_text) <br>INDEXTYPE IS CTXSYS.CONTEXT;<br></code></pre><br><br>---<br><br>#<h1>üîÅ Macro Expansion Function<br><br>Used to replace tokens like `#group` with their expanded terms.<br><br><pre><code class='sql'><br>CREATE OR REPLACE FUNCTION expand_macros(expr IN CLOB) RETURN CLOB IS<br>  expanded_expr CLOB := expr;<br>BEGIN<br>  FOR macro IN (SELECT group_name, words FROM word_groups) LOOP<br>    expanded_expr := REPLACE(expanded_expr, macro.group_name, '(' || macro.words || ')');<br>  END LOOP;<br>  RETURN expanded_expr;<br>END;<br></code></pre><br><br>---<br><br>#<h1>üîç Search & Highlight<br><br>##<h1>**Find Comments Matching Rules**<br><pre><code class='sql'><br>SELECT c.id, c.comment_text<br>FROM survey_comments c<br>JOIN comment_rules r<br>  ON CONTAINS(c.comment_text, expand_macros(r.rule_expr_raw), 1) > 0<br>WHERE r.exclude_expr_raw IS NULL <br>   OR CONTAINS(c.comment_text, expand_macros(r.exclude_expr_raw), 2) = 0;<br></code></pre><br><br>##<h1>**Get Highlighted Snippet**<br><pre><code class='sql'><br>SELECT CTX_DOC.SNIPPET('comment_text_idx', c.id, expand_macros(r.rule_expr_raw)) AS snippet<br>FROM survey_comments c<br>JOIN comment_rules r<br>  ON CONTAINS(c.comment_text, expand_macros(r.rule_expr_raw), 1) > 0;<br></code></pre><br><br>---<br><br>#<h1>üìä Summary Reporting<br><br>##<h1>**Option 1: Materialized View**<br><pre><code class='sql'><br>CREATE MATERIALIZED VIEW comment_rule_summary_mv<br>BUILD IMMEDIATE<br>REFRESH COMPLETE ON DEMAND<br>AS<br>SELECT r.id AS rule_id, r.topic, COUNT(*) AS match_count<br>FROM survey_comments c<br>JOIN comment_rules r<br>  ON CONTAINS(c.comment_text, expand_macros(r.rule_expr_raw), 1) > 0<br>WHERE r.exclude_expr_raw IS NULL<br>   OR CONTAINS(c.comment_text, expand_macros(r.exclude_expr_raw), 2) = 0<br>GROUP BY r.id, r.topic;<br></code></pre><br><br>Refresh manually:<br><pre><code class='sql'><br>EXEC DBMS_MVIEW.REFRESH('comment_rule_summary_mv');<br></code></pre><br><br>---<br><br>##<h1>**Option 2: Analytics Summary Table**<br><br><pre><code class='sql'><br>CREATE TABLE comment_rule_summary (<br>  rule_id NUMBER,<br>  rule_label VARCHAR2(255),<br>  topic VARCHAR2(255),<br>  match_count NUMBER,<br>  last_updated DATE DEFAULT SYSDATE<br>);<br></code></pre><br><br>###<h1>**Refresh Procedure**<br><pre><code class='sql'><br>CREATE OR REPLACE PROCEDURE refresh_comment_rule_summary IS<br>BEGIN<br>  DELETE FROM comment_rule_summary;<br><br>  INSERT INTO comment_rule_summary (rule_id, rule_label, topic, match_count)<br>  SELECT r.id, r.rule_expr_raw, r.topic, COUNT(*)<br>  FROM survey_comments c<br>  JOIN comment_rules r<br>    ON CONTAINS(c.comment_text, expand_macros(r.rule_expr_raw), 1) > 0<br>  WHERE r.exclude_expr_raw IS NULL<br>     OR CONTAINS(c.comment_text, expand_macros(r.exclude_expr_raw), 2) = 0<br>  GROUP BY r.id, r.rule_expr_raw, r.topic;<br><br>  COMMIT;<br>END;<br></code></pre><br><br>###<h1>**Scheduled Refresh**<br><pre><code class='sql'><br>BEGIN<br>  DBMS_SCHEDULER.CREATE_JOB (<br>    job_name        => 'refresh_rule_summary',<br>    job_type        => 'STORED_PROCEDURE',<br>    job_action      => 'refresh_comment_rule_summary',<br>    repeat_interval => 'FREQ=HOURLY;',<br>    enabled         => TRUE<br>  );<br>END;<br></code></pre><br><br>---<br><br>#<h1>‚è± Index Maintenance<br><br>Sync the Oracle Text index periodically:<br><br><pre><code class='sql'><br>BEGIN<br>  DBMS_SCHEDULER.CREATE_JOB (<br>    job_name        => 'sync_comment_text_index_hourly',<br>    job_type        => 'PLSQL_BLOCK',<br>    job_action      => 'BEGIN CTX_DDL.SYNC_INDEX(''comment_text_idx''); END;',<br>    repeat_interval => 'FREQ=HOURLY;BYMINUTE=0',<br>    enabled         => TRUE<br>  );<br>END;<br></code></pre>